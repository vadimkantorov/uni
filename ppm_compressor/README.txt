Code written together with @i_komarov and @vonosmas
